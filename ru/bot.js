const TelegramBot = require('node-telegram-bot-api')
const { setupReminders } = require('./reminders') // –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–æ–¥—É–ª—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
const { setupWeatherMessages } = require('./weather') // –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–æ–¥—É–ª—å –ø–æ–≥–æ–¥—ã
const { getRandomLoveMessage } = require('./messages') // –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–æ–¥—É–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π

// –¢–æ–∫–µ–Ω –æ—Ç BotFather
const token = 'your_token_here'

// –°–æ–∑–¥–∞—ë–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
const bot = new TelegramBot(token, { polling: true })

// –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ chatId
const allowedChatIds = ['yourGf_tg_id'] // –ò–∑ @myidbot –≤ —Ç–µ–ª–µ–≥—Ä–∞–º

// –ü—Ä–æ–≤–µ—Ä–∫–∞, —Ä–∞–∑—Ä–µ—à—ë–Ω –ª–∏ chatId
function isAllowed(chatId) {
    return allowedChatIds.includes(chatId.toString())
}

// –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –≤—Å–µ—Ö chatId
console.log('–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ –ø–æ–≥–æ–¥—É –¥–ª—è –≤—Å–µ—Ö —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö chatId...')
allowedChatIds.forEach(chatId => {
    console.log(`–ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è chatId: ${chatId}`)
    setupReminders(bot, chatId)

    console.log(`–ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–æ–≥–æ–¥–µ –¥–ª—è chatId: ${chatId}`)
    setupWeatherMessages(bot, chatId)
})

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
bot.onText(/\/start/, (msg) => {
    const chatId = msg.chat.id

    console.log(`–ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ /start –æ—Ç chatId: ${chatId}`) // –õ–æ–≥ –∫–æ–º–∞–Ω–¥—ã /start

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–∞–∑—Ä–µ—à—ë–Ω –ª–∏ chatId
    if (!isAllowed(chatId)) {
        bot.sendMessage(chatId, "–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É. üö´") // id –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ –¥–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∫ –±–æ—Ç—É
        console.log(`chatId: ${chatId} –Ω–µ —Ä–∞–∑—Ä–µ—à—ë–Ω –¥–ª—è –¥–æ—Å—Ç—É–ø–∞`)
        return
    }

    bot.sendMessage(chatId, "–ü—Ä–∏–≤–µ—Ç! –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø, –Ω—É–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç! \n\n–ö–∞–∫–æ–≥–æ —á–∏—Å–ª–∞ –º—ã –ø–æ–∑–Ω–∞–∫–æ–º–∏–ª–∏—Å—å?") // –ó–∞–¥–∞—ë–º –≤–æ–ø—Ä–æ—Å –¥–ª—è –æ–¥–Ω–æ–æ—Ç–≤–µ—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
    bot.once('message', (answer) => {
        console.log(`–û—Ç–≤–µ—Ç –Ω–∞ —Ç–µ—Å—Ç –æ—Ç chatId: ${chatId} -> ${answer.text}`)

        if (answer.text === "11") { // –£–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å, —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–≤–µ—Ç–∞.
            bot.sendMessage(chatId, "–ú–æ–ª–æ–¥–µ—Ü! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞!", {
                reply_markup: {
                    keyboard: [
                        [{ text: "–õ—é–±–∏—Ç –ª–∏ –º–µ–Ω—è name?" }], // –ü—Ä–∏–º–µ—Ä –∫–Ω–æ–ø–∫–∏, –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø—Ä–∏–∑–Ω–∞–Ω–∏—è–º–∏ –≤ –ª—é–±–≤–∏. –í –≤–∞—à–µ–º —Å–ª—É—á–∞–µ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —á—Ç–æ —É–≥–æ–¥–Ω–æ.
                    ],
                    resize_keyboard: true
                }
            })

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ–≥–æ–¥–µ
            console.log(`–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ–≥–æ–¥–µ –¥–ª—è chatId: ${chatId}`) // –õ–æ–≥–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∏ –ø–æ–≥–æ–¥—ã
            setupReminders(bot, chatId)
            setupWeatherMessages(bot, chatId)
        } else {
            bot.sendMessage(chatId, "–ï—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ—à–∏–±–ª–∞—Å—å, –Ω–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π, –Ω–∞–ø–∏—à–∏ /start.") // –ï—Å–ª–∏ id –≤–µ—Ä–Ω—ã–π, –∞ –æ—Ç–≤–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
            console.log(`chatId: ${chatId} –Ω–µ –ø—Ä–æ—à—ë–ª —Ç–µ—Å—Ç`) // –õ–æ–≥–∏ –Ω–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–∞
        }
    })
})

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ 
bot.on('message', (msg) => {
    const chatId = msg.chat.id

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–∞–∑—Ä–µ—à—ë–Ω –ª–∏ chatId
    if (!isAllowed(chatId)) {
        console.log(`chatId: ${chatId} –ø–æ–ø—ã—Ç–∞–ª—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, –Ω–æ –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω`) // –õ–æ–≥–∏ –ø–æ–ø—ã—Ç–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        return
    }

    if (msg.text === "–õ—é–±–∏—Ç –ª–∏ –º–µ–Ω—è Name?") {  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
        const loveMessage = getRandomLoveMessage()
        bot.sendMessage(chatId, loveMessage)
        console.log(`–û—Ç–≤–µ—Ç "–õ—é–±–∏—Ç –ª–∏ –º–µ–Ω—è Name?" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ chatId: ${chatId} -> ${loveMessage}`) // –õ–æ–≥–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    }
})

// –õ–æ–≥ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞
console.log('–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!') 